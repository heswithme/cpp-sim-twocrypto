This file explains how we were optimizing parameters for crvusd pair.

Idea: run backtests for refuel(donation,boost)-enabled twocrypto pools with various params, using historical candlestick data, and assuming arbitrageurs behave optimally, i.e. if they can make a profitable trade - they will do so with optimal size. 

Optimality of the trade depends on pool execution price (which itself is a function of pool historical state, current liquidity, and invariant/fee parameters), on cex price (we assume each candle can be sold into/bought from with infinite volume), and pool/cex fees. If arb can buy in pool cheaper than on cex - they will do so, thus pishing pool price higher (and contunuously equalizing pool price with cex price).

Pool parameters (A, mid/out fee, oracle smoothing time, some more internal knobs) define what kind of slippage is available. Low A -> close to xy=k (bad slippage), high A -> close to x+y=k (good slippage). Invariant used in twocrypto-ng-boost is curve's standard stableswap, check whitepaper if want math.

To begin with we scanned two key params (A/mid_fee) on wide range based on donation APY (1.A-midfee don sweep folder). No miracle was noted, resulting APY for any donation rate results in net losses for LPs. This assumes a single LP that themself donate to the pool, thus their profits from fees are counted MINUS donations. If donations are done by asset issuer, and LPs are natural users, then of course LP has profits proportionate to donations (and donations are at cost of asset issuer). However, very important, that backtesting is based ONLY on arbitrageurs, aimed to conservatively simulate pool performance, while on-chain FX assumes that organic volume is present and bringing more fees to the pool. Being conservative, we may let LPs net apy be negative.

We decided to stop at 5% yearly TVL donation APY, as it is the maximum that can be achieved with current pool parameters, as it seems to be a nice spot between minimizing slippage (check slippage lowest value in don0-2.5-5-7.5-10.png files), and overcompensating LPs.

Next folder (2.A-mid_fee don0.05) contains sweeps for mid_fee and A, with donation APY fixed at 5% determined to find optimal A and mid_fee parameters.
We took large initial range of A (1-2000) and mid_fee (0.01% to5%, [1 to 500bps]), and used logscale to find best are to zoom in. We played a bit with MA, but no noticeable changes, and ma866 (default) seems to fit good. The best possible pool quality is achieved when average time weighted slippage (tw_slippage, lower is better) plot is lowest in value, so this is the main parameter to optimize. This normally also correlates with pool ability to track external price (avg_rel_bps, lower is better).

We subsequently zoom into A 10-1000 and mid_fee 10-100 bps (log scale, 3a,3b,3c), and even more to A 50-500 (same mid_fee) on linear scale (4.). We see that to optimize slippage we should have A around 100 (dark blue front on tw_slippage in image 4.), so the last heatmap has scan A 40-200 (mid_fee 10to100bps). From here we see that depending on mid_fee values we can keep tw_slippage low by chosing A correctly. Two candidate points could be (A=120, mid_fee=~35), or (A=150, mid_fee=75). Former seemingly provides better price peg (lower values of avg_rel_bps in image 5.), while latter seems to grant more APY to LPs.

To properly estimate how critical the pool offpeg, we plot price_scale vs cex price for these two candiates. For added contrast we include (A=200, mid_fee=10bps) as well. 6. price_comparison.png shows that contrast item (200,10) has quite some price detachments (green price_scale is far from cex price for weeks). We remove this and come to (6a. price_comparison_clean.png), which shows that both pool setups have comparable price tracking, orange line (A=150, fee=75bps seem to follow less the high frequencies of cex price, thus potentially saving up on performing many rebalances). However, (A=120, fee=35bps) seems to have slightly better price tracking, as it is closer to cex price for most of the time. Otherwise, two candidate poits main difference is fee amount (35 bps vs 75 bps) that directly translates to LP profitability but at cost of higher fee.